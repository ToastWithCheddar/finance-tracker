<!DOCTYPE html>
<html>
<head>
    <title>Debug Auth Flow</title>
</head>
<body>
    <h1>Debug Auth Flow</h1>
    
    <h2>Current Cookies</h2>
    <div id="cookies"></div>
    
    <h2>Current LocalStorage</h2>
    <div id="localStorage"></div>
    
    <h2>Current SessionStorage</h2>
    <div id="sessionStorage"></div>
    
    <h2>Actions</h2>
    <button onclick="setTestCookies()">Set Test Cookies</button>
    <button onclick="clearAllStorage()">Clear All Storage</button>
    <button onclick="testApiCall()">Test API Call</button>
    <button onclick="testCompleteAuthFlow()">üß™ Test Complete Auth Flow</button>
    <div id="apiResult"></div>

    <script>
        function displayStorage() {
            // Show cookies
            document.getElementById('cookies').innerHTML = 
                `<pre>${document.cookie || 'No cookies found'}</pre>`;
            
            // Show localStorage
            const localStorageItems = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                localStorageItems.push(`${key}: ${localStorage.getItem(key)}`);
            }
            document.getElementById('localStorage').innerHTML = 
                `<pre>${localStorageItems.join('\n') || 'No localStorage items'}</pre>`;
            
            // Show sessionStorage
            const sessionStorageItems = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                sessionStorageItems.push(`${key}: ${sessionStorage.getItem(key)}`);
            }
            document.getElementById('sessionStorage').innerHTML = 
                `<pre>${sessionStorageItems.join('\n') || 'No sessionStorage items'}</pre>`;
        }
        
        function setTestCookies() {
            // Set test auth cookies with proper expiration timing
            document.cookie = "access_token=dev-mock-token-12345; path=/; max-age=900"; // 15 minutes
            document.cookie = "refresh_token=dev-mock-refresh-12345; path=/; max-age=604800"; // 7 days
            displayStorage();
            alert('Test cookies set with proper expiration times!');
        }
        
        function clearAllStorage() {
            // Clear cookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            displayStorage();
            alert('All storage cleared!');
        }
        
        async function testApiCall() {
            try {
                const response = await fetch('http://localhost:8000/api/auth/me', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer dev-mock-token-12345'
                    }
                });
                const data = await response.json();
                document.getElementById('apiResult').innerHTML = 
                    `<h3>API Response (${response.status})</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    `<h3>API Error</h3><pre>${error.message}</pre>`;
            }
        }
        
        async function testCompleteAuthFlow() {
            try {
                console.log('üß™ Testing complete authentication flow...');
                const results = {};
                
                // Test 1: Auth /me endpoint
                console.log('1Ô∏è‚É£ Testing /auth/me endpoint...');
                try {
                    const meResponse = await fetch('http://localhost:8000/api/auth/me', {
                        credentials: 'include',
                        headers: { 
                            'Authorization': 'Bearer dev-mock-token-12345',
                            'Content-Type': 'application/json'
                        }
                    });
                    const meData = await meResponse.json();
                    results.authMe = {
                        status: meResponse.status,
                        success: meResponse.ok,
                        data: meData
                    };
                } catch (error) {
                    results.authMe = { error: error.message };
                }
                
                // Test 2: Token refresh
                console.log('2Ô∏è‚É£ Testing token refresh...');
                try {
                    const refreshResponse = await fetch('http://localhost:8000/api/auth/refresh', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            refresh_token: 'dev-mock-refresh-12345'
                        })
                    });
                    const refreshData = await refreshResponse.json();
                    results.tokenRefresh = {
                        status: refreshResponse.status,
                        success: refreshResponse.ok,
                        data: refreshData
                    };
                } catch (error) {
                    results.tokenRefresh = { error: error.message };
                }
                
                // Test 3: Plaid link token
                console.log('3Ô∏è‚É£ Testing Plaid link token...');
                try {
                    const plaidResponse = await fetch('http://localhost:8000/api/accounts/plaid/link-token', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Authorization': 'Bearer dev-mock-token-12345',
                            'Content-Type': 'application/json'
                        },
                        body: '{}'
                    });
                    const plaidData = await plaidResponse.json();
                    results.plaidLinkToken = {
                        status: plaidResponse.status,
                        success: plaidResponse.ok,
                        data: plaidData
                    };
                } catch (error) {
                    results.plaidLinkToken = { error: error.message };
                }
                
                // Test 4: Account connection status
                console.log('4Ô∏è‚É£ Testing account connection status...');
                try {
                    const statusResponse = await fetch('http://localhost:8000/api/accounts/connection-status', {
                        credentials: 'include',
                        headers: {
                            'Authorization': 'Bearer dev-mock-token-12345',
                            'Content-Type': 'application/json'
                        }
                    });
                    const statusData = await statusResponse.json();
                    results.connectionStatus = {
                        status: statusResponse.status,
                        success: statusResponse.ok,
                        data: statusData
                    };
                } catch (error) {
                    results.connectionStatus = { error: error.message };
                }
                
                // Display comprehensive results
                document.getElementById('apiResult').innerHTML = `
                    <h3>üß™ Complete Auth Flow Test Results</h3>
                    
                    <h4>1Ô∏è‚É£ Auth /me (${results.authMe.status || 'ERROR'})</h4>
                    <pre>${JSON.stringify(results.authMe, null, 2)}</pre>
                    
                    <h4>2Ô∏è‚É£ Token Refresh (${results.tokenRefresh.status || 'ERROR'})</h4>
                    <pre>${JSON.stringify(results.tokenRefresh, null, 2)}</pre>
                    
                    <h4>3Ô∏è‚É£ Plaid Link Token (${results.plaidLinkToken.status || 'ERROR'})</h4>
                    <pre>${JSON.stringify(results.plaidLinkToken, null, 2)}</pre>
                    
                    <h4>4Ô∏è‚É£ Connection Status (${results.connectionStatus.status || 'ERROR'})</h4>
                    <pre>${JSON.stringify(results.connectionStatus, null, 2)}</pre>
                    
                    <h4>üìä Summary</h4>
                    <ul>
                        <li>Auth /me: ${results.authMe.success ? '‚úÖ PASS' : '‚ùå FAIL'}</li>
                        <li>Token refresh: ${results.tokenRefresh.success ? '‚úÖ PASS' : '‚ùå FAIL'}</li>
                        <li>Plaid link: ${results.plaidLinkToken.success ? '‚úÖ PASS' : '‚ùå FAIL'}</li>
                        <li>Connection status: ${results.connectionStatus.success ? '‚úÖ PASS' : '‚ùå FAIL'}</li>
                    </ul>
                `;
                
            } catch (error) {
                document.getElementById('apiResult').innerHTML = `
                    <h3>üö® Auth Flow Test Critical Error</h3>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Auto refresh display every second
        setInterval(displayStorage, 1000);
        displayStorage();
    </script>
</body>
</html>